mastodon:
  createAdmin:
    enabled: ${MASTODON_CREATE_ADMIN}
    username: ${MASTODON_ADMIN_USERNAME}
    email: ${MASTODON_ADMIN_EMAIL}
  locale: ${MASTODON_LOCALE}
  local_domain: ${MASTODON_LOCAL_DOMAIN}
  s3:
    enabled: true
    bucket: ${MASTODON_S3_BUCKET_NAME}
    existingSecret: ${MASTODON_S3_EXISTING_SECRET}
    endpoint: https://storage.googleapis.com
    hostname: storage.googleapis.com
  smtp:
    existingSecret: ${MASTODON_SMTP_EXISTING_SECRET}
  secrets:
    existingSecret: ${MASTODON_APP_EXISTING_SECRET_NAME}
  streaming:
    replicas: 2
  web:
    replicas: 2
  worker:
    replicas: 1

ingress:
  enabled: true
  annotations:
    kubernetes.io/ingress.global-static-ip-name: ${MASTODON_GLOBAL_IP_NAME}
    networking.gke.io/managed-certificates: ${NAME}-managed-certificate
    kubernetes.io/ingress.class: "gce"
  hosts:
    - host: ${MASTODON_LOCAL_DOMAIN}
      paths:
        - path: "/"
  tls: [] # We don't need this as it's managed by managed-certificates.

# ref: https://github.com/bitnami/charts/tree/main/bitnami/redis#parameters
redis:
  enabled: ${MASTODON_REDIS_ENABLED}
  hostname: ${MASTODON_REDIS_HOSTNAME}
  replica:
    replicaCount: 3
    nodeSelector:
      cloud.google.com/gke-spot: "true"
    resources:
      requests:
        cpu: 250m
        memory: 512Mi
  # Keep the master on a standard node.
  master:
    resources:
      requests:
        cpu: 250m
        memory: 512Mi
  auth:
    existingSecret: ${MASTODON_REDIS_SECRET_NAME}

# ref: https://github.com/bitnami/charts/tree/main/bitnami/elasticsearch#parameters
elasticsearch:
  enabled: false
  sysctlImage:
    enabled: false # THIS IS NOT COMPATIBLE WITH GKE AUTOPILOT.
  master:
    replicaCount: 1
  data:
    replicaCount: 1
  coordinating:
    replicaCount: 1
  ingest:
    replicaCount: 1

postgresql:
  enabled: false
  postgresqlHostname: ${MASTODON_POSTGRES_HOST}
  postgresqlPort: 5432
  auth:
    database: ${MASTODON_POSTGRES_DB}
    username: ${MASTODON_POSTGRES_USER}
    existingSecret: ${MASTODON_POSTGRES_SECRET_NAME}

service:
  type: NodePort

# Set the minimum resources as default for all pods: https://cloud.google.com/kubernetes-engine/docs/concepts/autopilot-resource-requests#min-max-requests
# Autopilot requests/limits: https://cloud.google.com/kubernetes-engine/docs/concepts/autopilot-resource-requests#min-max-requests
# Pricing calculator done till now: https://cloud.google.com/products/calculator/#id=aabc9042-8fbd-44e1-90d0-e3477a1f0eaf
## EUR 25 per 1 month to run only Mastodon pods, on spot VMs, 5 replicas.
resources:
  requests:
    cpu: 500m
    memory: 512Mi

nodeSelector:
  cloud.google.com/gke-spot: "true"
